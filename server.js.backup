import express from "express";
import mongoose from "mongoose";
import dotenv from "dotenv";
import rateLimit from "express-rate-limit";
import cors from "cors";
import Claim from "./models/Claim.js";
import crypto from "crypto";
import path from "path";
import { fileURLToPath } from "url";

dotenv.config();
const app = express();
app.set("trust proxy", 1);

// ðŸ§© Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ùˆ Ù¾ÙˆØ´Ù‡ Ø§ØµÙ„ÛŒ
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
const PORT = process.env.PORT || 5000;
const MONGO = process.env.MONGO_URI;

// ðŸ›¡ï¸ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ (Ø¶Ø¯ Ø§Ø³Ù¾Ù…)
app.use(
  rateLimit({
    windowMs: 60 * 1000,
    max: 20,
    message: { error: "â›” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯." },
  }),
);

// ðŸŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ CORS ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù…Ù†Ù‡ Ø§ØµÙ„ÛŒ
app.use(
  cors({
    origin: [
      "https://ruza-token.netlify.app", // âœ… Ø¯Ø§Ù…Ù†Ù‡ Ø±Ø³Ù…ÛŒ Ø³Ø§ÛŒØª
      "http://localhost:3000", // Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù…Ø­Ù„ÛŒ
    ],
    methods: ["GET", "POST", "PATCH"],
    allowedHeaders: ["Content-Type", "x-admin-token", "Authorization"],
  }),
);

// ðŸ§© Ø³Ø§ÛŒØ± Ù…ÛŒØ§Ù†â€ŒØ§ÙØ²Ø§Ø±Ù‡Ø§
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

// ðŸ“¡ Ø§ØªØµØ§Ù„ Ø¨Ù‡ MongoDB
mongoose
  .connect(MONGO, { serverSelectionTimeoutMS: 8000 })
  .then(() => console.log("âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯."))
  .catch((err) => console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ MongoDB:", err));

// ðŸ§¾ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„
function isValidAddr(a) {
  return typeof a === "string" && /^0x[a-fA-F0-9]{40}$/.test(a.trim());
}

// ------------------------
// ðŸ“¦ Ù…Ø³ÛŒØ± Ø«Ø¨Øª Claim
// ------------------------
app.post("/api/claim", async (req, res) => {
  try {
    const origin = req.get("origin");
    if (!["https://ruza-token.netlify.app", "http://localhost:3000"].includes(origin)) {
      console.warn("ðŸš« Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ù…Ù†Ø¨Ø¹ ØºÛŒØ±Ù…Ø¬Ø§Ø²:", origin);
      return res.status(403).json({ error: "Forbidden origin." });
    }

    const { address, referrer, contact } = req.body;
    const ip = req.ip;
    const ua = req.get("User-Agent") || "";

    if (!isValidAddr(address))
      return res.status(400).json({ error: "Invalid wallet address." });
    if (referrer && !isValidAddr(referrer))
      return res.status(400).json({ error: "Invalid referral address." });

    const exists = await Claim.findOne({ address: address.toLowerCase() });
    if (exists)
      return res.status(409).json({ error: "This wallet has already claimed." });

    const record = new Claim({
      address: address.toLowerCase(),
      referrer: referrer ? referrer.toLowerCase() : null,
      contact,
      ip,
      userAgent: ua,
    });
    await record.save();

    // ðŸŽ Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø±ÛŒÙØ±Ø§Ù„
    if (referrer) {
      await Claim.updateOne(
        { address: referrer.toLowerCase() },
        { $inc: { referrals: 1 } },
      );
    }

    return res.json({
      message: "âœ… Your claim has been received successfully.",
    });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³ÛŒØ± claim:", err);
    return res.status(500).json({ error: "Server error." });
  }
});

// ------------------------
// ðŸ“Š Ø¢Ù…Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ (Stats)
// ------------------------
app.get("/api/stats", async (req, res) => {
  try {
    const total = await Claim.countDocuments();
    const totalSupply = 1000000;
    const remaining = Math.max(totalSupply - total, 0);
    res.json({ total, remaining, totalSupply });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± stats:", err);
    res.status(500).json({ error: "Server error" });
  }
});

// ------------------------
// ðŸ” Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§
// ------------------------
app.get("/api/referrals/:address", async (req, res) => {
  try {
    const address = req.params.address.toLowerCase();
    const refCount = await Claim.countDocuments({ referrer: address });
    res.json({ address, totalReferrals: refCount });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: "Server error" });
  }
});

/* ------------------------
   ðŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†
   ------------------------ */
const ADMIN_USER = process.env.ADMIN_USER || "admin";
const ADMIN_PASS = process.env.ADMIN_PASS || "ruza2025";

const adminTokens = new Map();
const TOKEN_TTL_MS = 1000 * 60 * 60 * 6; // Û¶ Ø³Ø§Ø¹Øª

function generateAdminToken() {
  return crypto.randomBytes(24).toString("hex");
}
function cleanExpiredTokens() {
  const now = Date.now();
  for (const [t, meta] of adminTokens.entries()) {
    if (now - meta.createdAt > TOKEN_TTL_MS) adminTokens.delete(t);
  }
}
setInterval(cleanExpiredTokens, 1000 * 60 * 30);

function adminAuth(req, res, next) {
  const header =
    req.headers["x-admin-token"] ||
    (req.headers["authorization"] &&
      req.headers["authorization"].split(" ")[1]);
  if (!header) return res.status(401).json({ error: "Unauthorized" });
  const token = header.trim();
  if (!adminTokens.has(token))
    return res.status(401).json({ error: "Invalid or expired token" });
  next();
}

/* ------------------------
   ðŸ§© Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
   ------------------------ */
app.get("/admin", (req, res) => {
  res.sendFile(path.join(__dirname, "admin.html"));
});

app.post("/admin/login", (req, res) => {
  const { username, password } = req.body;
  if (username === ADMIN_USER && password === ADMIN_PASS) {
    const token = generateAdminToken();
    adminTokens.set(token, { createdAt: Date.now() });
    return res.json({ token, ttlHours: TOKEN_TTL_MS / (1000 * 60 * 60) });
  }
  return res.status(401).json({ error: "Invalid credentials" });
});

app.get("/admin/claims", adminAuth, async (req, res) => {
  const records = await Claim.find({}).sort({ createdAt: -1 }).lean();
  res.json(records);
});

app.get("/admin/export.csv", adminAuth, async (req, res) => {
  const records = await Claim.find({}).sort({ createdAt: 1 }).lean();
  const lines = ["address,referrer,contact,referrals,status,createdAt"];
  for (const r of records) {
    const address = r.address || "";
    const ref = r.referrer || "";
    const contact = (r.contact || "").replace(/,/g, " ");
    const referrals = r.referrals || 0;
    const status = r.status || "";
    const created = r.createdAt ? new Date(r.createdAt).toISOString() : "";
    lines.push(`${address},${ref},${contact},${referrals},${status},${created}`);
  }
  res.setHeader("Content-Type", "text/csv");
  res.setHeader("Content-Disposition", 'attachment; filename="ruza_claims.csv"');
  res.send(lines.join("\n"));
});

app.patch("/admin/claim/:address", adminAuth, async (req, res) => {
  try {
    const address = req.params.address.toLowerCase();
    const { status } = req.body;
    if (!["queued", "done", "rejected"].includes(status))
      return res.status(400).json({ error: "Invalid status" });
    const rec = await Claim.findOneAndUpdate(
      { address },
      { status },
      { new: true },
    );
    if (!rec) return res.status(404).json({ error: "Not found" });
    return res.json({ ok: true, record: rec });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ error: "Server error" });
  }
});

/* ------------------------
   ðŸŒ Ø³Ù„Ø§Ù…Øª Ø³Ø±ÙˆØ± + ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§ØªÛŒÚ©
   ------------------------ */
app.get("/health", (req, res) => res.json({ ok: true }));

app.use(express.static(path.join(__dirname)));

app.listen(PORT, () => console.log(`ðŸš€ RUZA Server running on port ${PORT}`));
